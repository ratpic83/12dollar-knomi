# Knomi Clone Configuration for Klipper
# 
# This file adds support for the Knomi Clone display
# Include this in your printer.cfg with: [include knomi.cfg]

# Macro variables for tracking printer state
[gcode_macro BedLevelVar]
variable_leveling: False
gcode:
  SET_GCODE_VARIABLE MACRO=BedLevelVar VARIABLE=leveling VALUE=False

[gcode_macro HomeSetVar]
variable_homing: False
gcode:
  SET_GCODE_VARIABLE MACRO=HomeSetVar VARIABLE=homing VALUE=False

# Override homing macros to set variables
[gcode_macro G28]
rename_existing: G28.1
gcode:
  SET_GCODE_VARIABLE MACRO=HomeSetVar VARIABLE=homing VALUE=True
  G28.1 {rawparams}
  SET_GCODE_VARIABLE MACRO=HomeSetVar VARIABLE=homing VALUE=False

# Bed leveling start
[gcode_macro BED_MESH_CALIBRATE]
rename_existing: BED_MESH_CALIBRATE.1
gcode:
  SET_GCODE_VARIABLE MACRO=BedLevelVar VARIABLE=leveling VALUE=True
  BED_MESH_CALIBRATE.1 {rawparams}
  SET_GCODE_VARIABLE MACRO=BedLevelVar VARIABLE=leveling VALUE=False

# Optional: Add custom display messages
[gcode_macro KNOMI_STATUS]
gcode:
  {% set msg = params.MSG|default("Status Update") %}
  M117 {msg}

# Print start notification
[gcode_macro PRINT_START]
rename_existing: PRINT_START.1
gcode:
  KNOMI_STATUS MSG="Print Starting"
  PRINT_START.1 {rawparams}

# Print end notification
[gcode_macro PRINT_END]
rename_existing: PRINT_END.1
gcode:
  PRINT_END.1 {rawparams}
  KNOMI_STATUS MSG="Print Complete"

# Pause notification
[gcode_macro PAUSE]
rename_existing: PAUSE.1
gcode:
  KNOMI_STATUS MSG="Print Paused"
  PAUSE.1 {rawparams}

# Resume notification
[gcode_macro RESUME]
rename_existing: RESUME.1
gcode:
  KNOMI_STATUS MSG="Resuming Print"
  RESUME.1 {rawparams}

# Cancel notification
[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT.1
gcode:
  KNOMI_STATUS MSG="Print Cancelled"
  CANCEL_PRINT.1 {rawparams}
